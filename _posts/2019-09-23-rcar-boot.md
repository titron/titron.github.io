---
layout: post
title:  "r-car 启动（boot）过程分析"
categories: r-car boot yocto ATF
tags: boot yocto ATF r-car
author: David
---

* content
{:toc}

r-car系列是Renesas公司的SOC，功能很强大。

从以下几个方面描述：

* 硬件准备
* 启动流程
* 启动地址
* 启动
* ATF IPL
* Yocto

# 硬件准备
r-carboards是必须得，[参考这里](https://elinux.org/R-Car)。

以下跳线指的是开发板（slavator-X（S）board）上的跳线。

* 选择主启动器

| 跳线MD[7:6] | 描述 |
|---|---|
| B'00 | 从CA57启动  |
| B'01 | 从CA53启动  |
| B'10 | -  |
| B'11 | 从CR7启动  |

* 选择启动状态

|  跳线MD[15] | 描述 |
|---|---|
|  B'0 | AArch32  |
|  B'1 | AArch64  |

* 选择启动模式

| 跳线MD[4:1] | 描述 |
|---|---|
| B'0000 | 从外部ROM启动  |
| B'0001 | - |
| B'0010 | 从HyperFlash ROM启动（160MHz），使用DMA |
| B'0011 | 从HyperFlash ROM启动（80MHz），使用DMA |
| B'0100 | 从Serial Flash ROM启动（40MHz），使用DMA |
| B'0101 | 从eMMC启动（25MHzx1总线宽度），使用DMA |
| B'0110 | - |
| B'0111 | - |
| B'1000 | - |
| B'1001 | - |
| B'1010 | 从HyperFlash ROM启动（160MHz），使用XIP模式 |
| B'1011 | 从HyperFlash ROM启动（80MHz），使用XIP模式 |
| B'1100 | - |
| B'1101 | 从eMMC启动（50MHzx8总线宽度），使用DMA |
| B'1110 | - |
| B'1111 | SCIF download模式 |

# 启动流程
下图是CA57/CA53/CR7的启动流程。

![CA57/CA53 boot](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-CA57.png)

![CR7 boot](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-CR7.png)


# 启动地址
启动地址由reset模块来决定。
如果Cortex-A57以AArch64启动，启动地址由MD15，MD[7:6]，RESET.CA57CPU0BARH/L寄存器决定。

如果Cortex-A57以AArch32启动并选择片上ROM启动，启动地址由RESET.CA57CPU0BARH/L寄存器决定。

如果Cortex-R7并选择片上ROM启动，启动地址由RESET.CR7BAR寄存器决定。

# 启动
从HyperFlash/Serial Flash ROM/eMMC启动,
主启动处理器跳转到H’EB100000（AArch32）或H’EB10C000（AArch64），执行boot ROM中的指令，并用SYS-DMAC CH0将5KB或7KB（eMMC）数据copy到内部RAM。
![启动参数](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-para.png)
这5KB或7KB（eMMC）数据包含Boot ROM参数（4bytes，存储在Serial Flash的H’0地址），IPL-A & B的地址信息及size信息。Boot ROM参数可以选择IPL-A还是IPL-B。
根据Boot ROM参数中指定的size，将IPL copy到RAM，传输完毕后，跳转到指定的IPL地址。参考下图。
然后，再将IPL（Initial Program Loader） copy到内部RAM，然后跳转到指定的地址。
![启动执行过程](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-copy.png)
![memory map分配](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-memorymap.png)

以从serial flash启动为例。

| SW | 设置 | 描述 |
|---|---|---|
| SW10[5:8] | B'0100 | 从serial flash ROM启动（40MHz）启动，使用DMA |
| SW1 | All ON | 使用serial flash ROM |
| SW2 | All ON | 使用serial flash ROM |
| SW3 | OFF | 使用serial flash ROM |

![启动成功Sample Loader和MiniMonitor](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-ok.png)

MiniMonitor能实现一些简单而有限的工作：

- 可以显示并编辑memory的内容
- loading用户程序等，例如用“xls2”命令更新升级下表中的firmware（可以选择将firwware烧写到Serial Flash或HyperFlash）。这些firmware是R-Car H3/M3/M3N基于Yocoto实现的工程例编译后生成的image。
![flash table](https://github.com/titron/titron.github.io/blob/master/img/2019-09-23-boot-flash.png)

# ATF IPL
# Yocto